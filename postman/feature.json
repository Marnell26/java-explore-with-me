{
  "info": {
    "_postman_id": "{{$guid}}",
    "name": "feature_comments",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "description": "Базовые тесты для комментариев Explore With Me"
  },
  "item": [
    {
      "name": "1. Create comment (201)",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const main = async () => {",
              "  const api = new API(pm);",
              "  const rnd = new RandomUtils();",
              "  try {",
              "    const user = await api.addUser(rnd.getUser());",
              "    const category = await api.addCategory(rnd.getCategory());",
              "    let event = await api.addEvent(user.id, rnd.getEvent(category.id));",
              "    event = await api.publishEvent(event.id);",
              "    pm.collectionVariables.set('userId', user.id);",
              "    pm.collectionVariables.set('eventId', event.id);",
              "  } catch (err) {",
              "    console.error('Ошибка при подготовке тестовых данных', err);",
              "  }",
              "};",
              "const interval = setInterval(() => {}, 1000);",
              "setTimeout(async () => {",
              "  try {",
              "    await main();",
              "  } finally {",
              "    clearInterval(interval);",
              "  }",
              "}, 100);"
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Статус 201 и json', function () {",
              "  pm.response.to.have.status(201);",
              "  pm.response.to.be.json;",
              "});",
              "",
              "pm.test('Комментарий имеет нужные поля', function () {",
              "  const c = pm.response.json();",
              "  pm.expect(c).to.have.property('id');",
              "  pm.expect(c).to.have.property('text');",
              "  pm.expect(c).to.have.property('author');",
              "  pm.expect(c).to.have.property('createdOn');",
              "  pm.collectionVariables.set('commentId', c.id);",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Accept",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"text\": \"Отличное событие, всё прошло супер!\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/users/{{userId}}/events/{{eventId}}/comments",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "users",
            "{{userId}}",
            "events",
            "{{eventId}}",
            "comments"
          ]
        }
      }
    },
    {
      "name": "2. Error: comment for unpublished event (409)",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const main = async () => {",
              "  const api = new API(pm);",
              "  const rnd = new RandomUtils();",
              "  try {",
              "    const user = await api.addUser(rnd.getUser());",
              "    const category = await api.addCategory(rnd.getCategory());",
              "    const event = await api.addEvent(user.id, rnd.getEvent(category.id)); // НЕ публикуем",
              "    pm.collectionVariables.set('unpubUserId', user.id);",
              "    pm.collectionVariables.set('unpubEventId', event.id);",
              "  } catch (err) {",
              "    console.error('Ошибка при подготовке тестовых данных', err);",
              "  }",
              "};",
              "const interval = setInterval(() => {}, 1000);",
              "setTimeout(async () => {",
              "  try {",
              "    await main();",
              "  } finally {",
              "    clearInterval(interval);",
              "  }",
              "}, 100);"
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Статус 409', function () {",
              "  pm.response.to.have.status(409);",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Accept",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"text\": \"Комментарий к неопубликованному событию\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/users/{{unpubUserId}}/events/{{unpubEventId}}/comments",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "users",
            "{{unpubUserId}}",
            "events",
            "{{unpubEventId}}",
            "comments"
          ]
        }
      }
    },
    {
      "name": "3. Get comments for event (200, not empty)",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const main = async () => {",
              "  const api = new API(pm);",
              "  const rnd = new RandomUtils();",
              "  try {",
              "    const user = await api.addUser(rnd.getUser());",
              "    const category = await api.addCategory(rnd.getCategory());",
              "    let event = await api.addEvent(user.id, rnd.getEvent(category.id));",
              "    event = await api.publishEvent(event.id);",
              "    await api.post('/users/' + user.id + '/events/' + event.id + '/comments', { text: 'Первый комментарий' });",
              "    await api.post('/users/' + user.id + '/events/' + event.id + '/comments', { text: 'Второй комментарий' });",
              "    pm.collectionVariables.set('eventForListId', event.id);",
              "  } catch (err) {",
              "    console.error('Ошибка при подготовке тестовых данных', err);",
              "  }",
              "};",
              "const interval = setInterval(() => {}, 1000);",
              "setTimeout(async () => {",
              "  try {",
              "    await main();",
              "  } finally {",
              "    clearInterval(interval);",
              "  }",
              "}, 100);"
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Статус 200', function () {",
              "  pm.response.to.have.status(200);",
              "});",
              "pm.test('JSON и не пустой массив', function () {",
              "  pm.response.to.be.json;",
              "  const list = pm.response.json();",
              "  pm.expect(list).to.be.an('array');",
              "  pm.expect(list.length).to.be.at.least(1);",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Accept",
            "value": "application/json"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/events/{{eventForListId}}/comments?from=0&size=10",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "events",
            "{{eventForListId}}",
            "comments"
          ],
          "query": [
            {
              "key": "from",
              "value": "0"
            },
            {
              "key": "size",
              "value": "10"
            }
          ]
        }
      }
    },
    {
      "name": "4. Update own comment (200)",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const main = async () => {",
              "  const api = new API(pm);",
              "  const rnd = new RandomUtils();",
              "  try {",
              "    const user = await api.addUser(rnd.getUser());",
              "    const category = await api.addCategory(rnd.getCategory());",
              "    let event = await api.addEvent(user.id, rnd.getEvent(category.id));",
              "    event = await api.publishEvent(event.id);",
              "    const comment = await api.post('/users/' + user.id + '/events/' + event.id + '/comments', { text: 'Старый текст' });",
              "    pm.collectionVariables.set('updUserId', user.id);",
              "    pm.collectionVariables.set('updCommentId', comment.id);",
              "  } catch (err) {",
              "    console.error('Ошибка при подготовке тестовых данных', err);",
              "  }",
              "};",
              "const interval = setInterval(() => {}, 1000);",
              "setTimeout(async () => {",
              "  try {",
              "    await main();",
              "  } finally {",
              "    clearInterval(interval);",
              "  }",
              "}, 100);"
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Статус 200 и json', function () {",
              "  pm.response.to.have.status(200);",
              "  pm.response.to.be.json;",
              "});",
              "pm.test('Текст обновился', function () {",
              "  const c = pm.response.json();",
              "  pm.expect(c.text).to.equal('Обновлённый текст комментария');",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "PATCH",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Accept",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"text\": \"Обновлённый текст комментария\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/users/{{updUserId}}/comments/{{updCommentId}}",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "users",
            "{{updUserId}}",
            "comments",
            "{{updCommentId}}"
          ]
        }
      }
    },
    {
      "name": "5. Delete own comment (204)",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const main = async () => {",
              "  const api = new API(pm);",
              "  const rnd = new RandomUtils();",
              "  try {",
              "    const user = await api.addUser(rnd.getUser());",
              "    const category = await api.addCategory(rnd.getCategory());",
              "    let event = await api.addEvent(user.id, rnd.getEvent(category.id));",
              "    event = await api.publishEvent(event.id);",
              "    const comment = await api.post('/users/' + user.id + '/events/' + event.id + '/comments', { text: 'На удаление' });",
              "    pm.collectionVariables.set('delUserId', user.id);",
              "    pm.collectionVariables.set('delCommentId', comment.id);",
              "  } catch (err) {",
              "    console.error('Ошибка при подготовке тестовых данных', err);",
              "  }",
              "};",
              "const interval = setInterval(() => {}, 1000);",
              "setTimeout(async () => {",
              "  try {",
              "    await main();",
              "  } finally {",
              "    clearInterval(interval);",
              "  }",
              "}, 100);"
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Статус 204', function () {",
              "  pm.response.to.have.status(204);",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "DELETE",
        "header": [
          {
            "key": "Accept",
            "value": "application/json"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/users/{{delUserId}}/comments/{{delCommentId}}",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "users",
            "{{delUserId}}",
            "comments",
            "{{delCommentId}}"
          ]
        }
      }
    },
    {
      "name": "6. Delete foreign comment must fail (404)",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const main = async () => {",
              "  const api = new API(pm);",
              "  const rnd = new RandomUtils();",
              "  try {",
              "    const owner = await api.addUser(rnd.getUser());",
              "    const stranger = await api.addUser(rnd.getUser());",
              "    const category = await api.addCategory(rnd.getCategory());",
              "    let event = await api.addEvent(owner.id, rnd.getEvent(category.id));",
              "    event = await api.publishEvent(event.id);",
              "    const comment = await api.post('/users/' + owner.id + '/events/' + event.id + '/comments', { text: 'Чужой комментарий' });",
              "    pm.collectionVariables.set('strangerId', stranger.id);",
              "    pm.collectionVariables.set('foreignCommentId', comment.id);",
              "  } catch (err) {",
              "    console.error('Ошибка при подготовке тестовых данных', err);",
              "  }",
              "};",
              "const interval = setInterval(() => {}, 1000);",
              "setTimeout(async () => {",
              "  try {",
              "    await main();",
              "  } finally {",
              "    clearInterval(interval);",
              "  }",
              "}, 100);"
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Статус 404 (нельзя удалить чужой)', function () {",
              "  pm.response.to.have.status(404);",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "DELETE",
        "header": [
          {
            "key": "Accept",
            "value": "application/json"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/users/{{strangerId}}/comments/{{foreignCommentId}}",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "users",
            "{{strangerId}}",
            "comments",
            "{{foreignCommentId}}"
          ]
        }
      }
    },
    {
      "name": "7. Admin delete comment (204)",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const main = async () => {",
              "  const api = new API(pm);",
              "  const rnd = new RandomUtils();",
              "  try {",
              "    const user = await api.addUser(rnd.getUser());",
              "    const category = await api.addCategory(rnd.getCategory());",
              "    let event = await api.addEvent(user.id, rnd.getEvent(category.id));",
              "    event = await api.publishEvent(event.id);",
              "    const comment = await api.post('/users/' + user.id + '/events/' + event.id + '/comments', { text: 'Для админ-удаления' });",
              "    pm.collectionVariables.set('adminCommentId', comment.id);",
              "  } catch (err) {",
              "    console.error('Ошибка при подготовке тестовых данных', err);",
              "  }",
              "};",
              "const interval = setInterval(() => {}, 1000);",
              "setTimeout(async () => {",
              "  try {",
              "    await main();",
              "  } finally {",
              "    clearInterval(interval);",
              "  }",
              "}, 100);"
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Статус 204', function () {",
              "  pm.response.to.have.status(204);",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "DELETE",
        "header": [
          {
            "key": "Accept",
            "value": "application/json"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/admin/comments/{{adminCommentId}}",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "admin",
            "comments",
            "{{adminCommentId}}"
          ]
        }
      }
    },
    {
      "name": "8. Create comment with empty text (400)",
      "event": [
        {
          "listen": "prerequest",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const main = async () => {",
              "  const api = new API(pm);",
              "  const rnd = new RandomUtils();",
              "  try {",
              "    const user = await api.addUser(rnd.getUser());",
              "    const category = await api.addCategory(rnd.getCategory());",
              "    let event = await api.addEvent(user.id, rnd.getEvent(category.id));",
              "    event = await api.publishEvent(event.id);",
              "    pm.collectionVariables.set('badUserId', user.id);",
              "    pm.collectionVariables.set('badEventId', event.id);",
              "  } catch (err) {",
              "    console.error('Ошибка при подготовке тестовых данных', err);",
              "  }",
              "};",
              "const interval = setInterval(() => {}, 1000);",
              "setTimeout(async () => {",
              "  try {",
              "    await main();",
              "  } finally {",
              "    clearInterval(interval);",
              "  }",
              "}, 100);"
            ]
          }
        },
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Статус 400', function () {",
              "  pm.response.to.have.status(400);",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Accept",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"text\": \"\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/users/{{badUserId}}/events/{{badEventId}}/comments",
          "host": [
            "{{baseUrl}}"
          ],
          "path": [
            "users",
            "{{badUserId}}",
            "events",
            "{{badEventId}}",
            "comments"
          ]
        }
      }
    }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "API = class {",
          "  constructor(postman, verbose = false, baseUrl = pm.collectionVariables.get('baseUrl') || 'http://localhost:8080') {",
          "    this.baseUrl = baseUrl;",
          "    this.pm = postman;",
          "    this._verbose = verbose;",
          "  }",
          "  async addUser(user) {",
          "    return this.post('/admin/users', user, 'Ошибка при добавлении пользователя: ');",
          "  }",
          "  async addCategory(category) {",
          "    return this.post('/admin/categories', category, 'Ошибка при добавлении категории: ');",
          "  }",
          "  async addEvent(userId, event) {",
          "    return this.post('/users/' + userId + '/events', event, 'Ошибка при добавлении события: ');",
          "  }",
          "  async publishEvent(eventId) {",
          "    return this.patch('/admin/events/' + eventId, { stateAction: 'PUBLISH_EVENT' }, 'Ошибка при публикации события: ');",
          "  }",
          "  async patch(path, body, errorText) {",
          "    return this.sendRequest('PATCH', path, body, errorText);",
          "  }",
          "  async post(path, body, errorText) {",
          "    return this.sendRequest('POST', path, body, errorText);",
          "  }",
          "  async sendRequest(method, path, body, errorText) {",
          "    return new Promise((resolve, reject) => {",
          "      let request = {",
          "        url: this.baseUrl + path,",
          "        method: method,",
          "        header: { 'Content-Type': 'application/json' },",
          "        body: body ? JSON.stringify(body) : ''",
          "      };",
          "      this.pm.sendRequest(request, (error, response) => {",
          "        if (error || response.code >= 400) {",
          "          console.error(errorText, error || response.json());",
          "          return reject(error || new Error(JSON.stringify(response.json())));",
          "        }",
          "        try {",
          "          resolve(response.json());",
          "        } catch (e) {",
          "          resolve(response);",
          "        }",
          "      });",
          "    });",
          "  }",
          "};",
          "",
          "RandomUtils = class {",
          "  getUser() {",
          "    return {",
          "      name: pm.variables.replaceIn('{{$randomFullName}}'),",
          "      email: pm.variables.replaceIn('{{$randomEmail}}')",
          "    };",
          "  }",
          "  getCategory() {",
          "    return {",
          "      name: pm.variables.replaceIn('{{$randomWord}}') + Math.floor(Math.random() * 100).toString()",
          "    };",
          "  }",
          "  getEvent(categoryId) {",
          "    return {",
          "      annotation: pm.variables.replaceIn('{{$randomLoremSentence}}'),",
          "      category: categoryId,",
          "      description: pm.variables.replaceIn('{{$randomLoremParagraphs}}'),",
          "      eventDate: this.getFutureDateTime(),",
          "      location: {",
          "        lat: parseFloat(pm.variables.replaceIn('{{$randomLatitude}}')),",
          "        lon: parseFloat(pm.variables.replaceIn('{{$randomLongitude}}'))",
          "      },",
          "      paid: false,",
          "      participantLimit: 10,",
          "      requestModeration: true,",
          "      title: pm.variables.replaceIn('{{$randomLoremSentence}}')",
          "    };",
          "  }",
          "  getFutureDateTime() {",
          "    const moment = require('moment');",
          "    return moment().add(5, 'hours').format('YYYY-MM-DD HH:mm:ss');",
          "  }",
          "};"
        ]
      }
    }
  ],
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:8080",
      "type": "string"
    }
  ]
}